<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Happy Trails â€“ Registration</title>
	<style>
		body { font-family: Arial, sans-serif; margin: 20px; }
		label { display: block; margin-top: 10px; }
		input, select { width: 300px; padding: 5px; margin-top: 5px; }
		button { margin-top: 15px; padding: 10px 20px; }
		iframe { border: none; margin-top: 20px; width: 100%; }
		#game-container { display: none; }
	</style>
</head>
<body>

	<h2>Register / Edit Player</h2>
	<form id="userForm">
		<label>Email
			<input type="email" id="email" required>
		</label>

		<label>Handle
			<input type="text" id="handle" required>
		</label>

		<label>Name
			<input type="text" id="name" required>
		</label>

		<label>Surname
			<input type="text" id="surname" required>
		</label>

		<label>Your access code to the game (remember this, it's important)
			<input type="text" id="code" required>
		</label>

		<label>Locality
      <select id="locality" required>
        <!-- All your locality options here (unchanged) -->
      </select>
    </label>

		<button type="submit">Submit</button>
	</form>

	<button id="loadUserBtn">Load User</button>
	<button id="saveUserBtn">Save Changes</button>
	<button id="playBtn">Play Game</button>

	<script>
		const firebaseUrl = "https://godotgamelinktest-default-rtdb.europe-west1.firebasedatabase.app/";
		let currentUsername = null;

		function sanitizeEmail(email) {
			return email.replace(/\./g, ",")
						.replace(/@/g, "_at_")
						.replace(/\s+/g, "");
		}

		// --- Form Submission ---
		document.getElementById("userForm").addEventListener("submit", async (e) => {
			e.preventDefault();
			const email = document.getElementById("email").value.trim().toLowerCase();
			const handle = document.getElementById("handle").value.trim();
			const name = document.getElementById("name").value.trim();
			const surname = document.getElementById("surname").value.trim();
			const code = document.getElementById("code").value.trim();
			const locality = document.getElementById("locality").value;

			const usersRes = await fetch(firebaseUrl + "users.json");
			const usersData = await usersRes.json();
			const nextId = usersData ? Object.keys(usersData).length + 1 : 1;
			const username = (name.toLowerCase() + nextId);

			const userObj = { email, handle, name, surname, code, locality, id: nextId };

			await fetch(firebaseUrl + "users/" + username + ".json", { method: "PUT", body: JSON.stringify(userObj) });

			const emailKey = sanitizeEmail(email);
			await fetch(firebaseUrl + "emails/" + emailKey + ".json", { method: "PUT", body: JSON.stringify(username) });

			alert("User registered successfully as " + username);
			document.getElementById("userForm").reset();
		});

		// --- Load User ---
		document.getElementById("loadUserBtn").addEventListener("click", async () => {
			const email = prompt("Enter the user's email to load:");
			if (!email) return;

			const emailKey = sanitizeEmail(email.toLowerCase());
			const usernameRes = await fetch(firebaseUrl + "emails/" + emailKey + ".json");
			const username = await usernameRes.json();
			if (!username) { alert("User not found"); return; }

			const userRes = await fetch(firebaseUrl + "users/" + username + ".json");
			const userData = await userRes.json();
			if (!userData) { alert("User data not found"); return; }

			document.getElementById("email").value = userData.email || "";
			document.getElementById("handle").value = userData.handle || "";
			document.getElementById("name").value = userData.name || "";
			document.getElementById("surname").value = userData.surname || "";
			document.getElementById("code").value = userData.code || "";
			document.getElementById("locality").value = userData.locality || "";

			currentUsername = username;
		});

		// --- Save Changes ---
		document.getElementById("saveUserBtn").addEventListener("click", async () => {
			if (!currentUsername) { alert("Please load a user first!"); return; }

			const email = document.getElementById("email").value.trim().toLowerCase();
			const handle = document.getElementById("handle").value.trim();
			const name = document.getElementById("name").value.trim();
			const surname = document.getElementById("surname").value.trim();
			const code = document.getElementById("code").value.trim();
			const locality = document.getElementById("locality").value;

			const userObj = { email, handle, name, surname, code, locality };

			await fetch(firebaseUrl + "users/" + currentUsername + ".json", { method: "PUT", body: JSON.stringify(userObj) });
			const emailKey = sanitizeEmail(email);
			await fetch(firebaseUrl + "emails/" + emailKey + ".json", { method: "PUT", body: JSON.stringify(currentUsername) });

			alert("User profile updated successfully.");
		});

		// --- Play Game ---
		let gameWindow = null;
		document.getElementById("playBtn").addEventListener("click", () => {
			const gamePage = "gamepage.html";

			if (window.innerWidth < 768) {
				gameWindow = window.open(gamePage, "_blank");
			} else {
				const height = Math.floor(window.innerHeight * 0.95);
				const width = Math.floor(height / 1.8);
				const left = Math.floor((window.screen.width - width) / 2);
				const top = Math.floor((window.screen.height - height) / 2);

				gameWindow = window.open(gamePage, "_blank",
					`width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=no`);
			}
		});

		// --- Handle Game Close ---
		window.addEventListener("message", (event) => {
			if (event.data && event.data.type === "gameClosed") {
				console.log("Game closed signal received.");
				if (gameWindow && !gameWindow.closed) gameWindow.close();
				window.location.href = "https://ruaangrobler.github.io/HappyTrailstest/";
			}
		});
	</script>

</body>
</html>
