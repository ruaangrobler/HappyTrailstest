<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Happy Trails â€“ Registration</title>
	<style>
		body { font-family: Arial, sans-serif; margin: 20px; }
		label { display: block; margin-top: 10px; }
		input, select { width: 300px; padding: 5px; margin-top: 5px; }
		button { margin-top: 15px; padding: 10px 20px; }
	</style>
</head>
<body>

<h2>Register / Edit Player</h2>

<form id="userForm">
	<label>Email <input type="email" id="email" required></label>
	<label>Permanent Handle <input type="text" id="handle" required></label>
	<label>Name <input type="text" id="name" required></label>
	<label>Surname <input type="text" id="surname" required></label>
	<label>Locality
		<select id="locality" required>
			<option value="">-- Select locality --</option>
			<option value="Attard">Attard</option>
			<option value="Birkirkara">Birkirkara</option>
			<option value="Sliema">Sliema</option>
			<option value="Valletta">Valletta</option>
			<option value="Other">Other</option>
		</select>
	</label>

	<button type="submit">Submit</button>
</form>

<button id="loadUserBtn">Load User</button>
<button id="saveUserBtn">Save Changes</button>
<button id="playBtn">Login and Launch</button>

<script>
	const apiKey = "AIzaSyD5jutjuSD6ViglIS3PYxxYDtrLpxjS1lY";
	const firebaseUrl = "https://godotgamelinktest-default-rtdb.europe-west1.firebasedatabase.app/";
	let idToken = null;
	let currentUsername = null;

	// ðŸ”¹ Firebase anonymous auth
	async function firebaseAuth() {
		const res = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${apiKey}`, {
			method: "POST",
			body: JSON.stringify({ returnSecureToken: true }),
			headers: { "Content-Type": "application/json" }
		});
		const data = await res.json();
		idToken = data.idToken;
		console.log("Authenticated with Firebase:", data.localId);
	}

	function sanitizeEmail(email) {
		return email.replace(/\./g, ",").replace(/@/g, "_at_").replace(/\s+/g, "");
	}

	function generateToken() {
		return Math.random().toString(36).substring(2, 10) + Math.random().toString(36).substring(2, 10);
	}

	// ðŸ”¹ Register new user
	document.getElementById("userForm").addEventListener("submit", async (e) => {
		e.preventDefault();
		if (!idToken) await firebaseAuth();

		const email = document.getElementById("email").value.trim().toLowerCase();
		const handle = document.getElementById("handle").value.trim();
		const name = document.getElementById("name").value.trim();
		const surname = document.getElementById("surname").value.trim();
		const locality = document.getElementById("locality").value;

		// Generate unique token
		const userToken = generateToken();
		currentUsername = userToken;

		const userObj = { email, handle, name, surname, locality };

		// Save user under random token
		await fetch(`${firebaseUrl}users/${userToken}.json?auth=${idToken}`, {
			method: "PUT",
			body: JSON.stringify(userObj)
		});

		// Map email -> token for lookups
		const emailKey = sanitizeEmail(email);
		await fetch(`${firebaseUrl}emails/${emailKey}.json?auth=${idToken}`, {
			method: "PUT",
			body: JSON.stringify(userToken)
		});

		alert("User registered successfully!");
	});

	// ðŸ”¹ Load existing user by email
	document.getElementById("loadUserBtn").addEventListener("click", async () => {
		const email = prompt("Enter the user's email:");
		if (!email) return;

		const emailKey = sanitizeEmail(email.toLowerCase());
		const usernameRes = await fetch(`${firebaseUrl}emails/${emailKey}.json`);
		const username = await usernameRes.json();
		if (!username) { alert("User not found."); return; }

		const userRes = await fetch(`${firebaseUrl}users/${username}.json`);
		const userData = await userRes.json();
		if (!userData) { alert("User data missing."); return; }

		document.getElementById("email").value = userData.email || "";
		document.getElementById("handle").value = userData.handle || "";
		document.getElementById("name").value = userData.name || "";
		document.getElementById("surname").value = userData.surname || "";
		document.getElementById("locality").value = userData.locality || "";

		currentUsername = username;
		alert("User loaded successfully.");
	});

	// ðŸ”¹ Save changes
	document.getElementById("saveUserBtn").addEventListener("click", async () => {
		if (!currentUsername) return alert("Load a user first!");

		const email = document.getElementById("email").value.trim().toLowerCase();
		const handle = document.getElementById("handle").value.trim();
		const name = document.getElementById("name").value.trim();
		const surname = document.getElementById("surname").value.trim();
		const locality = document.getElementById("locality").value;
		const userObj = { email, handle, name, surname, locality };

		await fetch(`${firebaseUrl}users/${currentUsername}.json?auth=${idToken}`, {
			method: "PUT",
			body: JSON.stringify(userObj)
		});

		const emailKey = sanitizeEmail(email);
		await fetch(`${firebaseUrl}emails/${emailKey}.json?auth=${idToken}`, {
			method: "PUT",
			body: JSON.stringify(currentUsername)
		});

		alert("User updated successfully.");
	});

	// ðŸ”¹ Play Game
	document.getElementById("playBtn").addEventListener("click", () => {
		if (!currentUsername) return alert("Please register or load a user first!");

		const gameURL = `gamepage.html?user_token=${encodeURIComponent(currentUsername)}`;
		console.log("Opening:", gameURL);

		const width = 500, height = 900;
		const left = (screen.width / 2) - (width / 2);
		const top = (screen.height / 2) - (height / 2);

		const gameWindow = window.open(
			gameURL,
			"HappyTrailsGame",
			`width=${width},height=${height},left=${left},top=${top},resizable=no,scrollbars=no,status=no`
		);

		window.addEventListener("message", (event) => {
			if (event.data && event.data.type === "gameClosed") {
				if (gameWindow && !gameWindow.closed) gameWindow.close();
				window.location.href = "https://ruaangrobler.github.io/HappyTrailstest/";
			}
		});
	});
</script>

</body>
</html>
