<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Happy Trails â€“ Game</title>
<style>
	html, body {
		margin: 0;
		padding: 0;
		width: 100%;
		height: 100%;
		overflow: hidden;
	}
	iframe {
		position: absolute;
		top: 0; left: 0;
		width: 100%;
		height: 100%;
		border: none;
	}
</style>
</head>
<body>
	<script>
	// Send close event to parent and close self
	function closeGame() {
		console.log("Game closing requested.");
		if (window.opener && !window.opener.closed) {
			window.opener.postMessage({ type: "gameClosed" }, "*");
		}
		window.close();
	}

	// Listen for close requests from Godot
	window.addEventListener("message", function(event) {
		if (event.data && event.data.type === "gameClosed") {
			closeGame();
		}
	});
</script>

<iframe id="gameFrame" src=""></iframe>

<script>
	// --- Get URL query parameters (email, token, etc.) ---
	function getQueryParams() {
		const params = {};
		const queryString = window.location.search.substring(1);
		const pairs = queryString.split("&");
		for (const pair of pairs) {
			const [key, value] = pair.split("=");
			if (key) params[decodeURIComponent(key)] = decodeURIComponent(value || "");
		}
		return params;
	}

	const params = getQueryParams();
	console.log("Incoming query params:", params);

	// --- Build iframe URL (pass to Godot game) ---
	let gameUrl = "game/index.html";
	const query = new URLSearchParams(params).toString();
	if (query) gameUrl += "?" + query;

	document.getElementById("gameFrame").src = gameUrl;

	// --- Listen for game close signal from Godot ---
	window.addEventListener("message", function(event){
		if(event.data && event.data.type === "gameClosed"){
			console.log("Game requested close.");
			if(window.opener && !window.opener.closed){
				window.opener.postMessage({ type: "gameClosed" }, "*");
			}
			window.close();
		}
	});

	// --- Listen for copy-to-clipboard from Godot ---
	window.addEventListener("message", function(event) {
		if (event.data && event.data.type === "copyCode") {
			const code = event.data.code;
			if (navigator.clipboard && navigator.clipboard.writeText) {
				navigator.clipboard.writeText(code)
					.then(() => alert("Code copied: " + code))
					.catch(err => console.error("Clipboard error:", err));
			} else {
				const input = document.createElement("input");
				input.value = code;
				document.body.appendChild(input);
				input.select();
				document.execCommand("copy");
				document.body.removeChild(input);
				alert("Code copied: " + code);
			}
		}
	});
</script>

</body>
</html>
